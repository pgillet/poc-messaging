#!/bin/bash

gcloud compute --project=meteofrance-poc-messaging firewall-rules create rabbitmq-server --direction=INGRESS --priority=1000 --network=default --action=ALLOW --rules=tcp:15672 --source-ranges=0.0.0.0/0 --target-tags=rabbitmq-server

gcloud beta compute --project=meteofrance-poc-messaging instances create instance-2 --zone=europe-west1-b --machine-type=n1-standard-1 --subnet=default --network-tier=PREMIUM --maintenance-policy=MIGRATE --service-account=76639503321-compute@developer.gserviceaccount.com --scopes=https://www.googleapis.com/auth/devstorage.read_only,https://www.googleapis.com/auth/logging.write,https://www.googleapis.com/auth/monitoring.write,https://www.googleapis.com/auth/servicecontrol,https://www.googleapis.com/auth/service.management.readonly,https://www.googleapis.com/auth/trace.append --tags=rabbitmq-server --image=rabbitmq-server --image-project=meteofrance-poc-messaging --boot-disk-size=43GB --boot-disk-type=pd-standard --boot-disk-device-name=instance-2 --reservation-affinity=any


gcloud beta compute --project=meteofrance-poc-messaging instances create rabbitmq-server-01 --zone=europe-west1-b --machine-type=n1-standard-1 --subnet=default --network-tier=PREMIUM --metadata=^,@^startup-script=\#\!/bin/bash$'\n'$'\n'\#\ sudo-enabled\ user\ on\ the\ VM:\ vagrant/vagrant$'\n'$'\n'HOSTNAME=\$\(hostname\ --short\)$'\n'FQDN=\$\(hostname\ --fqdn\)$'\n'$'\n'\#\ See\ https://www.rabbitmq.com/install-rpm.html$'\n'$'\n'\#\ Install\ pygpgme,\ a\ package\ which\ allows\ yum\ to\ handle\ gpg\ signatures,\ $'\n'\#\ and\ a\ package\ called\ yum-utils\ which\ contains\ the\ tools\ you\ need\ for\ installing\ source\ RPMs\ $'\n'\#yum\ -y\ -q\ install\ pygpgme\ yum-utils$'\n'$'\n'cat\ \<\<EOM\ \>\ /etc/yum.repos.d/rabbitmq_erlang.repo$'\n'\[rabbitmq_erlang\]$'\n'name=rabbitmq_erlang$'\n'baseurl=https://packagecloud.io/rabbitmq/erlang/el/6/x86_64$'\n'repo_gpgcheck=1$'\n'gpgcheck=0$'\n'enabled=1$'\n'gpgkey=https://packagecloud.io/rabbitmq/erlang/gpgkey$'\n'sslverify=1$'\n'sslcacert=/etc/pki/tls/certs/ca-bundle.crt$'\n'metadata_expire=300$'\n'$'\n'\[rabbitmq_erlang-source\]$'\n'name=rabbitmq_erlang-source$'\n'baseurl=https://packagecloud.io/rabbitmq/erlang/el/6/SRPMS$'\n'repo_gpgcheck=1$'\n'gpgcheck=0$'\n'enabled=1$'\n'gpgkey=https://packagecloud.io/rabbitmq/erlang/gpgkey$'\n'sslverify=1$'\n'sslcacert=/etc/pki/tls/certs/ca-bundle.crt$'\n'metadata_expire=300$'\n'EOM$'\n'$'\n'yum\ -q\ makecache\ -y\ --disablerepo=\'\*\'\ --enablerepo=\'rabbitmq_erlang\'$'\n'$'\n'\#\ Install\ Erlang\ \(Zero-dependency\ from\ RabbitMQ\)$'\n'yum\ -y\ -q\ install\ erlang$'\n'$'\n'cat\ \<\<EOM\ \>\ /etc/yum.repos.d/rabbitmq_rabbitmq-server.repo$'\n'\[rabbitmq_rabbitmq-server\]$'\n'name=rabbitmq_rabbitmq-server$'\n'baseurl=https://packagecloud.io/rabbitmq/rabbitmq-server/el/7/x86_64$'\n'repo_gpgcheck=1$'\n'gpgcheck=0$'\n'enabled=1$'\n'gpgkey=https://packagecloud.io/rabbitmq/rabbitmq-server/gpgkey$'\n'sslverify=1$'\n'sslcacert=/etc/pki/tls/certs/ca-bundle.crt$'\n'metadata_expire=300$'\n'$'\n'\[rabbitmq_rabbitmq-server-source\]$'\n'name=rabbitmq_rabbitmq-server-source$'\n'baseurl=https://packagecloud.io/rabbitmq/rabbitmq-server/el/7/SRPMS$'\n'repo_gpgcheck=1$'\n'gpgcheck=0$'\n'enabled=1$'\n'gpgkey=https://packagecloud.io/rabbitmq/rabbitmq-server/gpgkey$'\n'sslverify=1$'\n'sslcacert=/etc/pki/tls/certs/ca-bundle.crt$'\n'metadata_expire=300$'\n'EOM$'\n'$'\n'yum\ -q\ makecache\ -y\ --disablerepo=\'\*\'\ --enablerepo=\'rabbitmq_rabbitmq-server\'$'\n'$'\n'\#\ Install\ RabbitMQ\ Server$'\n'\#\ import\ the\ new\ PackageCloud\ key\ that\ will\ be\ used\ starting\ December\ 1st,\ 2018\ \(GMT\)$'\n'rpm\ --import\ https://packagecloud.io/rabbitmq/rabbitmq-server/gpgkey$'\n'$'\n'\#\ import\ the\ old\ PackageCloud\ key\ that\ will\ be\ discontinued\ on\ December\ 1st,\ 2018\ \(GMT\)$'\n'rpm\ --import\ https://packagecloud.io/gpg.key$'\n'$'\n'yum\ -y\ -q\ install\ rabbitmq-server$'\n'$'\n'\#\ Configuring\ RabbitMQ$'\n'\#\ Controlling\ system\ limits\ with\ systemd$'\n'cat\ \<\<EOM\ \>\ /etc/systemd/system/rabbitmq-server.service.d/limits.conf$'\n'\[Service\]$'\n'LimitNOFILE=64000$'\n'EOM$'\n'$'\n'\#\ Enable\ plugins$'\n'\#echo\ \"\[rabbitmq_management,rabbitmq_mqtt,rabbitmq_peer_discovery_consul\].\"\ \|\ sudo\ tee\ /etc/rabbitmq/enabled_plugins$'\n'echo\ \"\[rabbitmq_management,rabbitmq_mqtt,rabbitmq_peer_discovery_consul\].\"\ \>\ /etc/rabbitmq/enabled_plugins$'\n'$'\n'\#\ Clustering\ -\ Peer\ discovery\ using\ Consul$'\n'cat\ \<\<EOM\ \>\ /etc/rabbitmq/rabbitmq.conf$'\n'cluster_formation.peer_discovery_backend\ =\ rabbit_peer_discovery_consul$'\n'cluster_formation.consul.host\ =\ consul$'\n'EOM$'\n'$'\n'\#\ Start\ the\ server$'\n'chkconfig\ rabbitmq-server\ on$'\n'/sbin/service\ rabbitmq-server\ start$'\n'$'\n'$'\n'if\ \[\[\ \"\$\{HOSTNAME\}\"\ ==\ rabbitmq-server-01\ \]\]\;$'\n'then\ $'\n'\	\#\ Access\ control$'\n'\	\#\ Create\ a\ RabbitMQ\ user\ called\ \"meteofr\"$'\n'\	rabbitmqctl\ add_user\ meteofr\ meteofr$'\n'$'\n'\	\#\ Create\ a\ new\ virtual\ host\ called\ \"test\"$'\n'\	rabbitmqctl\ add_vhost\ test$'\n'$'\n'\	\#\ Grant\ the\ user\ named\ \"meteofr\"\ access\ to\ the\ virtual\ host\ called\ \"test\",\ $'\n'\	\#\ with\ configure\ permissions\ on\ all\ resources\ whose\ names\ starts\ with\ \"meteofr-\",\ $'\n'\	\#\ and\ write\ and\ read\ permissions\ on\ all\ resources$'\n'\	rabbitmqctl\ set_permissions\ -p\ test\ meteofr\ \"^meteofr-.\*\"\ \".\*\"\ \".\*\"$'\n'$'\n'\	\#\ Tag\ the\ user\ with\ \"administrator\"\ for\ full\ management\ UI\ and\ HTTP\ API\ access$'\n'\	rabbitmqctl\ set_user_tags\ meteofr\ administrator$'\n'$'\n'\	\#\ Delete\ the\ defaut\ guest\ user\ as\ a\ primary\ security\ measure$'\n'\	rabbitmqctl\ delete_user\ guest$'\n'else\ $'\n'\	\#\ Clustering$'\n'\	rabbitmqctl\ stop_app$'\n'\	rabbitmqctl\ join_cluster\ rabbit@rabbitmq-server-01$'\n'\	rabbitmqctl\ start_app$'\n'fi$'\n'$'\n'\#\ Check\ on\ service\ status\ as\ observed\ by\ service\ manager$'\n'service\ rabbitmq-server\ status$'\n'$'\n'\#\ Runs\ the\ precheck\ tool\ to\ scan\ for\ any\ compatibility\ issues\ that\ might\ cause\ the\ $'\n'\#\ import\ process\ to\ fail\ or\ the\ disk\ to\ not\ work\ properly\ on\ Google\ Compute\ Engine$'\n'\#curl\ https://storage.googleapis.com/compute-image-tools/release/linux/import_precheck\ --output\ import_precheck$'\n'\#chmod\ u\+x\ import_precheck$'\n'\#./import_precheck --maintenance-policy=MIGRATE --service-account=76639503321-compute@developer.gserviceaccount.com --scopes=https://www.googleapis.com/auth/devstorage.read_only,https://www.googleapis.com/auth/logging.write,https://www.googleapis.com/auth/monitoring.write,https://www.googleapis.com/auth/servicecontrol,https://www.googleapis.com/auth/service.management.readonly,https://www.googleapis.com/auth/trace.append --tags=rabbitmq-server --image=centos-7-v20190813 --image-project=centos-cloud --boot-disk-size=200GB --boot-disk-type=pd-standard --boot-disk-device-name=rabbitmq-server-01 --reservation-affinity=any
